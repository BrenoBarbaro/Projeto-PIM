#include <stdio.h>
#include <locale.h>
#include <string.h>
#include <windows.h>
#include <conio.h>

typedef struct produtos
{
    char codProduto[5];
    char nomeProduto[21];
    double valorProduto;
    struct Lista *proximo;
} Lista;

typedef struct compras
{
    char codProduto[5];
    char nomeProduto[21];
    double valorProduto;
    struct ListaCompras *proximo;
} ListaCompras;

typedef struct usuarios
{
    char usuarioCadastrado[11];
    char senhaCadastrado[11];
    struct Login *proximo;
}Login;

Lista *inicio = NULL;
ListaCompras *cprodutos = NULL;
Login *ListaUsers = NULL;

void gotoxy(int x, int y){
     SetConsoleCursorPosition(GetStdHandle(STD_OUTPUT_HANDLE),(COORD){x-1,y-1});
}

void produtosVendidos();
void saldoDia();
void administrativeSystem();
void ExibeProdutos();
void DesingCaixa();
void menu();


//-------------------------------------------------------------------------------

int main(void)
{
    
    char sn;
    int op,op1,op2,op3;
    int cProduto,qtd;
    int x=0;

    do
    {
        

            menu();
            gotoxy(15,10);scanf("%d",&op);
            switch(op)
            {
                case 1: DesingCaixa(); break;

                case 2: administrativeSystem(); break;

                case 5: sair(); break;

                default:    printf("\n\nOpcao invalida!\t\t");  system("PAUSE");    break;

            }
    }while(op!=5);

    return 0;
}

void menu()
{
    system("cls");
    printf("******************************************************");
    printf("\n*                 NewHorizon Market                  *");
    printf("\n*                                                    *");
    printf("\n*      1 - Sistema de Caixa                          *");
    printf("\n*      2 - Sistema Administrativo                    *");
    printf("\n*                                                    *");
    printf("\n*      5 - Sair                                      *");
    printf("\n*                                                    *");
    printf("\n******************************************************");
    printf("\n*      Opcao:                                        *");
    printf("\n******************************************************");
}

void DesingCaixa()
{
    int op1;
    system("cls");
    printf("******************************************************");
    printf("\n*                Sistema de Mercado                  *");
    printf("\n*                                                    *");
    printf("\n*      1 - Iniciar Compras                           *");
    printf("\n*                                                    *");
    printf("\n*                                                    *");
    printf("\n*      5 - Sair                                      *");
    printf("\n*                                                    *");
    printf("\n******************************************************");
    printf("\n*      Opcao:                                        *");
    printf("\n******************************************************\n");
    gotoxy(15,10);scanf("%d",&op1);
    switch(op1)
    {
        case 1:
                iniciaCompra();

        break;
        default: printf("\n\nTecla invalida!\n"); break;
    }
}

void iniciaCompra()
{
    Lista *adicionar = (Lista *) malloc(sizeof(Lista));
    adicionar->proximo = NULL;
    Lista *aux = inicio;
    ListaCompras *aux2 = cprodutos;

    char numProduto[5];

    system("CLS");
    if(aux==NULL)
    {
        printf("Nao ha produtos para venda.\n\n");
    }
    else
    {
        ExibeProdutos();
        printf("\n\n(Digite o codigo do produto desejado)");
        printf("\n\nCodigo: ");
        scanf("%4s",numProduto);
        fflush(stdin);
        while(aux != NULL)
        {
            if( (strcmp(aux->codProduto, numProduto)) == 0)
            {
                if(cprodutos == NULL)
                {
                    cprodutos = aux;
                }
                else
                {
                    while(aux2->proximo!=NULL)
                    {

                        aux2=aux2->proximo;
                    }
                    aux2->proximo=aux;
                }
                printf("\n\n");
                while(aux2!=NULL)
                {
                    printf("%s\t%s\t%0.2f",aux2->codProduto,aux2->nomeProduto,aux2->valorProduto);
                    aux2=aux2->proximo;
                }
            }
        }
    }
    system("PAUSE");
}

//-------------------------------------------------------------------------------

void administrativeSystem()
{
    int op1;
    system("CLS");
    printf("*************************************************");
    printf("\n*          Sistema de Administrativo            *");
    printf("\n*                                               *");
    printf("\n*   1 - Saldo de Vendas do Dia                  *");
    printf("\n*   2 - Produtos Vendidos                       *");
    printf("\n*   3 - Adicionar Produtos                      *");
    printf("\n*   4 - Exibir Produtos                         *");
    printf("\n*                                               *");
    printf("\n*   5 - Sair                                    *");
    printf("\n*                                               *");
    printf("\n*************************************************");
    printf("\n*   Opcao:                                      *");
    printf("\n*************************************************\n");
    gotoxy(12,12);scanf("%d",&op1);
    switch(op1)
    {
        case 1: saldoDia(); break;

        case 2: produtosVendidos(); break;

        case 3: adicionarProdutos();    break;

        case 4: ExibeProdutos(); system("PAUSE");   break;
    }
}

void saldoDia()
{
    system("CLS");
    printf("*********************************************************************");
    printf("\n*                        Saldos do Dia                              *");
    printf("\n*                                                                   *");
    printf("\n*   N. Venda:        Quantidade de Produtos:        Valor:          *");
    printf("\n*                                                                   *");
    printf("\n*        1                    85                    R$ 458.78       *");
    printf("\n*        2                     7                    R$ 15.82        *");
    printf("\n*        3                    15                    R$ 31.02        *");
    printf("\n*        4                     5                    R$ 10.98        *");
    printf("\n*        5                    19                    R$ 19.19        *");
    printf("\n*        6                    45                    R$ 65.75        *");
    printf("\n*        7                   126                    R$ 726.15       *");
    printf("\n*        8                    72                    R$ 389.17       *");
    printf("\n*        9                    23                    R$ 25.12        *");
    printf("\n*        10                   31                    R$ 43.68        *");
    printf("\n*        11                   14                    R$ 20.98        *");
    printf("\n*                                                                   *");
    printf("\n*********************************************************************\n");
    system("PAUSE");
}

void produtosVendidos()
{
    system("CLS");
    printf("*********************************************************************");
    printf("\n*                       Produtos Vendidos                          *");
    printf("\n*                                                                  *");
    printf("\n*      Nome do Produtos:                        Quantidade:        *");
    printf("\n*                                                                  *");
    printf("\n*      1- Arroz                                                    *");
    printf("\n*      2- Feijao                                 R$ 15.82          *");
    printf("\n*      3- Macarrao                               R$ 31.02          *");
    printf("\n*      4- Molho de Tomate                        R$ 10.98          *");
    printf("\n*      5- Sorvete                                R$ 19.19          *");
    printf("\n*      6- Bolacha                                R$ 65.75          *");
    printf("\n*      7- Sabao em Po                            R$ 726.15         *");
    printf("\n*      8- Pao frances                            R$ 389.17         *");
    printf("\n*      9- batata                                 R$ 25.12          *");
    printf("\n*     10- Abobrinha                              R$ 43.68          *");
    printf("\n*     11- Tomate                                 R$ 20.98          *");
    printf("\n*                                                                  *");
    printf("\n********************************************************************\n");
    system("PAUSE");
}

void adicionarProdutos()
{
    Lista *novo = (Lista *) malloc(sizeof(Lista));
    if(!novo)
    {
        printf("Memoria nao indisponivel!\n\n");
    }
    else
    {
        novo->proximo = NULL;
        Lista *aux;
        aux = inicio;

            system("CLS");
            printf("*********************************************************************");
            printf("\n*                                                                   *");
            printf("\n*                       Adicionar Produtos                          *");
            printf("\n*                                                                   *");
            printf("\n*                                                                   *");
            printf("\n*     Codigo do Produto:                                            *");
            printf("\n*                                                                   *");
            printf("\n*     Nome do Produto:                                              *");
            printf("\n*                                                                   *");
            printf("\n*     Valor do produto:                                             *");
            printf("\n*                                                                   *");
            printf("\n*                                                                   *");
            printf("\n*                                                                   *");
            printf("\n*                                                                   *");
            printf("\n*********************************************************************\n");
            fflush(stdin);
            gotoxy(26,6);scanf("%4s", novo->codProduto);
            fflush(stdin);
            gotoxy(24,8);scanf("%20s", novo->nomeProduto);
            gotoxy(25,10);printf("R$");
            fflush(stdin);
            gotoxy(28,10);scanf("%lf",&novo->valorProduto);
            gotoxy(7,13);printf("Produto adicionado com sucesso!");
            if(inicio == NULL)
            {
                inicio = novo;
            }
            else
            {
                while(aux->proximo!=NULL)
                {
                    aux = aux->proximo;
                }
                aux->proximo = novo;
            }
    }
}

void ExibeProdutos()
{
    Lista *aux;
    aux = inicio;

    system("CLS");
    if(aux!=NULL)
    {
        int y=5;
        printf("***********************************************************************\n");
        printf("                                                                       \n");
        printf("    Codigo:              Nome:                       Valor:              ");
        printf("                                                                       ");
        while(aux!=NULL)
        {
            gotoxy(5,y);printf("%s",aux->codProduto);
            gotoxy(26,y);printf("%s",aux->nomeProduto);
            gotoxy(54,y);printf("%0.2lf",aux->valorProduto);
            aux = aux->proximo;
            y++;
        }
        printf("\n                                                                     ");
        printf("\n***********************************************************************\n\n");
    }
}

void cadastroUsuario()
{
    FILE *pUser;

    Login *novo = (Login*) malloc(sizeof(Login));
    Login *aux = ListaUsers;

    printf("---> Cadastro de Usuario <---\n\n");
    printf("Login: ");
    fflush(stdin);
    fgets(novo->usuarioCadastrado,sizeof(novo->usuarioCadastrado),stdin);
    novo->usuarioCadastrado[strcspn(novo->usuarioCadastrado,"\r\n")] = '\0';
    printf("Senha: ");
    fflush(stdin);
    fgets(novo->senhaCadastrado,sizeof(novo->senhaCadastrado),stdin);
    novo->senhaCadastrado[strcspn(novo->senhaCadastrado,"\r\n")] = '\0';
    fflush(stdin);
    if(ListaUsers==NULL)
    {
        ListaUsers=novo;
        pUser = fopen("Usuarios.txt","w");
        fprintf(pUser,"%s%s",ListaUsers->usuarioCadastrado,ListaUsers->senhaCadastrado);
        fclose(pUser);
    }
    else
    {
        pUser = fopen("Usuarios.txt","a");
        fprintf(pUser,"%s",ListaUsers->senhaCadastrado);
        fprintf(pUser,"%s",ListaUsers->usuarioCadastrado);
        fclose(pUser);
    }
}

int MostraLogin()
{
    Login *aux=ListaUsers;
    Login *lLogin = (Login*) malloc(sizeof(Login));
    lLogin->proximo = NULL;

    FILE *log;
    FILE *log2;
    log = fopen("Log.txt","w");
    fclose(log);

    char usuario[11];
    char senha[11];

    if(ListaUsers==NULL)
    {
        log =fopen("Log.txt","a");
        fprintf(log,"Usuarios nao cadastrados\n");
        fclose(log);
        return 1;
    }
    else if(ListaUsers!=NULL)
    {
        log = fopen("Log.txt","r");
        fscanf(log,"%s",ListaUsers->usuarioCadastrado);
        fscanf(log,"%s",ListaUsers->senhaCadastrado);
        fclose(log);

        Login *aux = ListaUsers;
        printf("---> Tela Inicial <---\n\n");
        printf("Login: ");
        fflush(stdin);
        fgets(usuario,sizeof(usuario),stdin);
        usuario[strcspn(usuario,"\r\n")] = '\0';
        fflush(stdin);
        if(strcmp(usuario,aux->usuarioCadastrado),stdin)
        {
            printf("1");
            printf("\nSenha:");
            fgets(senha,sizeof(senha),stdin);
            senha[strcspn(senha,"\r\n")] = '\0';
            if(strcmp(senha,aux->senhaCadastrado),stdin)
            {
                menu();
            }
        }
        else
        {
            printf("\n\Fail");
            if(log == NULL)
            {
                log2 = fopen("UserInvalido.txt","w");
                fputs(usuario,log2);
                fclose(log2);
            }
            else
            {
                log = fopen("UserInvalido.txt","a");
                fputs(usuario,log);
                fclose(log);
            }
            system("PAUSE");
        }
    }
}

void sair()
{
    system("CLS");
    printf("*************************************************");
    printf("\n*                                               *");
    printf("\n*     Obrigado , NewHorizon Market agradece     *");
    printf("\n*         sua presenca, volte sempre.           *");
    printf("\n*                                               *");
    printf("\n*************************************************\n");
}
